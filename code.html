<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emisor de Facturas - ACUÑA LOLY DIKSON YAMPIER</title>
    <style>
        /* --- Estilos Generales --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        :root {
            --primary-color: #003366;
            --secondary-color: #004080;
            --accent-color: #ffcc00;
            --text-color: #333;
            --bg-color: #f4f7f6;
            --border-color: #ddd;
            --light-gray: #e9ecef;
            --white: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3 {
            color: var(--primary-color);
            font-weight: 700;
        }

        h1 {
            text-align: center;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        /* --- Formularios y Inputs --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* --- Tabla de Ítems --- */
        .items-table-container {
            margin: 30px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--light-gray);
            color: var(--primary-color);
            font-weight: 700;
        }

        td input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: #28a745;
            color: var(--white);
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            margin-top: 20px;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: var(--white);
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        /* --- Totales --- */
        .totals {
            text-align: right;
            font-size: 1.1rem;
            margin-top: 20px;
        }

        .totals div {
            margin-bottom: 10px;
        }

        .totals .total-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* --- Vista Previa de Factura (oculta) --- */
        #invoice-preview {
            position: absolute;
            left: -9999px;
            width: 800px;
            padding: 40px;
            font-family: 'Roboto', sans-serif;
            background: white;
        }

        #invoice-preview .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        #invoice-preview .company-info h2 {
            margin: 0;
            font-size: 1.5em;
        }
        #invoice-preview .invoice-details h3 {
            margin: 0;
            font-size: 1.2em;
        }
        #invoice-preview .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        #invoice-preview .details-grid div p {
            margin: 5px 0;
        }
        #invoice-preview .details-grid strong {
            display: inline-block;
            width: 100px;
        }
        #invoice-preview table {
            width: 100%;
            margin-bottom: 30px;
        }
        #invoice-preview table th, #invoice-preview table td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        #invoice-preview .totals-section {
            text-align: right;
        }
        #invoice-preview .totals-section p {
            margin: 5px 0;
        }
        #invoice-preview .totals-section .total {
            font-weight: bold;
            font-size: 1.3em;
        }
        .disclaimer {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Generador de Facturas</h1>
        
        <div class="disclaimer">
            <strong>Nota:</strong> Esta herramienta genera un PDF con formato de factura. Para la validez tributaria ante SUNAT, se requiere un proceso de certificación y envío electrónico que esta app no realiza.
        </div>

        <form id="invoice-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="serie">Serie (ej: F001)</label>
                    <input type="text" id="serie" value="F001" required>
                </div>
                <div class="form-group">
                    <label for="numero">Número (ej: 00001)</label>
                    <input type="number" id="numero" value="1" required>
                </div>
                <div class="form-group full-width">
                    <label for="fecha-emision">Fecha de Emisión</label>
                    <input type="date" id="fecha-emision" required>
                </div>
            </div>

            <h2>Datos del Cliente</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="cliente-ruc">RUC / DNI</label>
                    <input type="text" id="cliente-ruc" placeholder="Ej: 20123456789" required>
                </div>
                <div class="form-group">
                    <label for="cliente-razon-social">Razón Social / Nombres</label>
                    <input type="text" id="cliente-razon-social" placeholder="Nombre completo del cliente" required>
                </div>
                <div class="form-group full-width">
                    <label for="cliente-direccion">Dirección</label>
                    <input type="text" id="cliente-direccion" placeholder="Dirección del cliente">
                </div>
            </div>

            <h2>Detalle de Productos / Servicios</h2>
            <div class="items-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Cantidad</th>
                            <th>Valor Unitario (S/)</th>
                            <th>Subtotal (S/)</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body">
                        <!-- Los ítems se agregarán aquí dinámicamente -->
                    </tbody>
                </table>
                <button type="button" class="btn btn-primary" onclick="addItem()">+ Agregar Ítem</button>
            </div>

            <div class="totals">
                <div><strong>Subtotal (S/):</strong> <span id="subtotal">0.00</span></div>
                <div><strong>IGV (18%):</strong> <span id="igv">0.00</span></div>
                <div class="total-amount"><strong>Total a Pagar (S/):</strong> <span id="total">0.00</span></div>
            </div>

            <button type="button" class="btn btn-success" onclick="generatePDF()">Generar Factura PDF</button>
        </form>
    </div>

    <!-- Contenedor oculto para la vista previa que se convertirá en PDF -->
    <div id="invoice-preview"></div>

    <!-- Scripts para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        const { jsPDF } = window.jspdf;
        const IGV_RATE = 0.18;

        // --- DATOS DE LA EMPRESA ---
        // Aquí están tus datos actualizados
        const COMPANY_DATA = {
            ruc: '10735084726', 
            razonSocial: 'ACUÑA LOLY DIKSON YAMPIER',
            direccion: 'Tu Dirección Aquí', // Puedes agregar tu dirección si lo deseas
        };

        let itemCount = 0;

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer la fecha de hoy por defecto
            document.getElementById('fecha-emision').valueAsDate = new Date();
            // Agregar el primer ítem
            addItem();
        });

        // --- FUNCIONES PARA MANEJO DE ÍTEMS ---
        function addItem() {
            itemCount++;
            const tableBody = document.getElementById('items-table-body');
            const row = document.createElement('tr');
            row.id = `item-row-${itemCount}`;
            row.innerHTML = `
                <td><input type="number" class="item-qty" value="1" min="1" onchange="calculateTotals()"></td>
                <td><input type="number" class="item-price" value="0.00" step="0.01" min="0" onchange="calculateTotals()"></td>
                <td class="item-subtotal">0.00</td>
                <td><button type="button" class="btn btn-danger" onclick="removeItem(${itemCount})">Eliminar</button></td>
            `;
            tableBody.appendChild(row);
            calculateTotals();
        }

        function removeItem(id) {
            const row = document.getElementById(`item-row-${id}`);
            if (document.querySelectorAll('#items-table-body tr').length > 1) {
                row.remove();
                calculateTotals();
            } else {
                alert('Debe haber al menos un ítem en la factura.');
            }
        }

        // --- CÁLCULOS ---
        function calculateTotals() {
            let subtotal = 0;
            const rows = document.querySelectorAll('#items-table-body tr');

            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const itemSubtotal = qty * price;
                row.querySelector('.item-subtotal').textContent = itemSubtotal.toFixed(2);
                subtotal += itemSubtotal;
            });

            const igv = subtotal * IGV_RATE;
            const total = subtotal + igv;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('igv').textContent = igv.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }

        // --- GENERACIÓN DEL PDF ---
        function generatePDF() {
            calculateTotals(); // Asegurarse de que los totales estén actualizados

            const serie = document.getElementById('serie').value;
            const numero = document.getElementById('numero').value;
            const fechaEmision = document.getElementById('fecha-emision').value;
            const clienteRuc = document.getElementById('cliente-ruc').value;
            const clienteRazonSocial = document.getElementById('cliente-razon-social').value;
            const clienteDireccion = document.getElementById('cliente-direccion').value;

            if (!clienteRuc || !clienteRazonSocial) {
                alert('Por favor, complete los datos del cliente.');
                return;
            }
            
            // Validar que haya al menos un ítem con precio
            let hasValidItem = false;
            document.querySelectorAll('#items-table-body tr').forEach(row => {
                const price = parseFloat(row.querySelector('.item-price').value);
                if (price > 0) {
                    hasValidItem = true;
                }
            });

            if (!hasValidItem) {
                alert('Por favor, agregue al menos un ítem con un precio válido.');
                return;
            }


            const preview = document.getElementById('invoice-preview');
            let itemsHtml = '';
            document.querySelectorAll('#items-table-body tr').forEach(row => {
                const qty = row.querySelector('.item-qty').value;
                const price = parseFloat(row.querySelector('.item-price').value).toFixed(2);
                const subtotal = parseFloat(row.querySelector('.item-subtotal').textContent).toFixed(2);
                if(parseFloat(price) > 0) {
                    itemsHtml += `
                        <tr>
                            <td style="text-align:center;">${qty}</td>
                            <td style="text-align:right;">${price}</td>
                            <td style="text-align:right;">${subtotal}</td>
                        </tr>
                    `;
                }
            });

            preview.innerHTML = `
                <div class="header">
                    <div class="company-info">
                        <h2>${COMPANY_DATA.razonSocial}</h2>
                        <p>RUC: ${COMPANY_DATA.ruc}</p>
                        <p>${COMPANY_DATA.direccion}</p>
                    </div>
                    <div class="invoice-details">
                        <h3>FACTURA ELECTRÓNICA</h3>
                        <p><strong>Serie:</strong> ${serie}</p>
                        <p><strong>Número:</strong> ${String(numero).padStart(6, '0')}</p>
                        <p><strong>Fecha de Emisión:</strong> ${new Date(fechaEmision).toLocaleDateString('es-PE')}</p>
                    </div>
                </div>
                <div class="details-grid">
                    <div>
                        <h4>Cliente</h4>
                        <p><strong>Razón Social:</strong> ${clienteRazonSocial}</p>
                        <p><strong>RUC / DNI:</strong> ${clienteRuc}</p>
                        <p><strong>Dirección:</strong> ${clienteDireccion || 'N/A'}</p>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 20%;">Cantidad</th>
                            <th style="width: 40%;">Valor Unitario (S/)</th>
                            <th style="width: 40%;">Subtotal (S/)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                <div class="totals-section">
                    <p><strong>Subtotal (S/):</strong> ${document.getElementById('subtotal').textContent}</p>
                    <p><strong>IGV (18%):</strong> ${document.getElementById('igv').textContent}</p>
                    <p class="total"><strong>Total a Pagar (S/):</strong> ${document.getElementById('total').textContent}</p>
                </div>
            `;

            // Usar html2canvas y jsPDF para crear el PDF
            window.html2canvas(preview).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // Ancho A4 en mm
                const pageHeight = 295; // Altura A4 en mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`Factura-${serie}-${String(numero).padStart(6, '0')}.pdf`);
            });
        }
    </script>
</body>
</html>

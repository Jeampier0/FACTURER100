<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Facturaci√≥n SUNAT - ACU√ëA LOLY DIKSON YAMPIER v2.0</title>
    <style>
        /* --- Estilos Generales --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');

        :root {
            --primary-color: #003366;
            --secondary-color: #004080;
            --accent-color: #ffcc00;
            --text-color: #333;
            --bg-color: #f4f7f6;
            --border-color: #ddd;
            --light-gray: #e9ecef;
            --white: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3 {
            color: var(--primary-color);
            font-weight: 700;
        }

        h1 {
            text-align: center;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        /* --- Formularios y Inputs --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* --- Tabla de √çtems --- */
        .items-table-container {
            margin: 30px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--light-gray);
            color: var(--primary-color);
            font-weight: 700;
        }

        td input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: #28a745;
            color: var(--white);
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            margin-top: 20px;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: var(--white);
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        /* --- Totales --- */
        .totals {
            text-align: right;
            font-size: 1.1rem;
            margin-top: 20px;
        }

        .totals div {
            margin-bottom: 10px;
        }

        .totals .total-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* --- Vista Previa de Factura (oculta) --- */
        #invoice-preview {
            position: absolute;
            left: -9999px;
            width: 800px;
            padding: 40px;
            font-family: 'Roboto', sans-serif;
            background: white;
        }

        #invoice-preview .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        #invoice-preview .company-info h2 {
            margin: 0;
            font-size: 1.5em;
        }
        #invoice-preview .invoice-details h3 {
            margin: 0;
            font-size: 1.2em;
        }
        #invoice-preview .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        #invoice-preview .details-grid div p {
            margin: 5px 0;
        }
        #invoice-preview .details-grid strong {
            display: inline-block;
            width: 100px;
        }
        #invoice-preview table {
            width: 100%;
            margin-bottom: 30px;
        }
        #invoice-preview table th, #invoice-preview table td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        #invoice-preview .totals-section {
            text-align: right;
        }
        #invoice-preview .totals-section p {
            margin: 5px 0;
        }
        #invoice-preview .totals-section .total {
            font-weight: bold;
            font-size: 1.3em;
        }
        .disclaimer {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- Sistema de Pesta√±as --- */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-color);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background-color: var(--light-gray);
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* --- √Årea de Resultados --- */
        .result-area {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-area pre {
            background-color: var(--white);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        input[type="password"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
        }

        textarea {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            width: 100%;
            min-height: 150px;
            font-family: monospace;
        }

        .btn-info {
            background-color: #17a2b8;
            color: var(--white);
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-warning {
            background-color: #ffc107;
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .status-success {
            background-color: #28a745;
            color: white;
        }

        .status-error {
            background-color: #dc3545;
            color: white;
        }

        .status-pending {
            background-color: #ffc107;
            color: var(--text-color);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Sistema de Facturaci√≥n Electr√≥nica - SUNAT</h1>
        
        <div class="disclaimer">
            <strong>Nota:</strong> Sistema integrado con los servicios de SUNAT para gesti√≥n de comprobantes electr√≥nicos.
        </div>

        <!-- Sistema de Pesta√±as -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('config', this)">‚öôÔ∏è Configuraci√≥n</button>
            <button class="tab-button" onclick="showTab('invoice', this)">üìÑ Generar Factura</button>
            <button class="tab-button" onclick="showTab('controlcpe', this)">üîç Control CPE</button>
            <button class="tab-button" onclick="showTab('migeigv', this)">üìö MIGE IGV</button>
            <button class="tab-button" onclick="showTab('gem', this)">üì§ GRE Emisi√≥n</button>
            <button class="tab-button" onclick="showTab('controlmsg', this)">üì® Control Mensajes</button>
            <button class="tab-button" onclick="showTab('sspp', this)">üìã SSPP Receptor</button>
        </div>

        <!-- Pesta√±a: Configuraci√≥n -->
        <div id="config" class="tab-content active">
            <h2>Configuraci√≥n de Credenciales SUNAT</h2>
            <div class="disclaimer" style="background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; margin-bottom: 20px;">
                <strong>üìã Instrucciones:</strong> Ingresa las credenciales de API que obtuviste en el portal de SUNAT (Men√∫ SOL ‚Üí Credenciales de API SUNAT). 
                Estas credenciales son diferentes a tu usuario y contrase√±a SOL.
            </div>
            <form id="config-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="sunat-api-id">ID de API SUNAT</label>
                        <input type="text" id="sunat-api-id" placeholder="Tu ID de API (ej: a8485be7-fb67-41e6-9036-bc903e197cab)">
                        <small style="color: #666; font-size: 0.9rem;">ID obtenido al registrar tu aplicaci√≥n en SUNAT</small>
                    </div>
                    <div class="form-group">
                        <label for="sunat-api-key">Clave de API SUNAT</label>
                        <input type="text" id="sunat-api-key" placeholder="Tu Clave de API (ej: ICn48qF1KeV5hW6opF55Mw==)">
                        <small style="color: #666; font-size: 0.9rem;">Clave obtenida al registrar tu aplicaci√≥n en SUNAT</small>
                    </div>
                    <div class="form-group">
                        <label for="sunat-usuario">Usuario SOL (Opcional - para servicios adicionales)</label>
                        <input type="text" id="sunat-usuario" placeholder="Tu usuario SOL (si es necesario)">
                    </div>
                    <div class="form-group">
                        <label for="sunat-password">Contrase√±a SOL (Opcional - para servicios adicionales)</label>
                        <input type="password" id="sunat-password" placeholder="Tu contrase√±a SOL (si es necesario)">
                    </div>
                    <div class="form-group">
                        <label for="sunat-ruc">RUC</label>
                        <input type="text" id="sunat-ruc" value="10735084726" required>
                    </div>
                    <div class="form-group">
                        <label for="sunat-api-url">URL Base API SUNAT</label>
                        <input type="text" id="sunat-api-url" value="https://api.sunat.gob.pe" placeholder="URL de la API">
                        <small style="color: #666; font-size: 0.9rem;">Usa https://api.sunat.gob.pe para producci√≥n</small>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                    <button type="button" class="btn btn-info" onclick="loadExampleCredentials()">üìã Cargar Credenciales de Ejemplo</button>
                </div>
            </form>
            <div id="config-result" class="result-area" style="display: none;"></div>
        </div>

        <!-- Pesta√±a: Generar Factura -->
        <div id="invoice" class="tab-content">
            <h2>Generar Factura</h2>
            <form id="invoice-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="serie">Serie (ej: F001)</label>
                    <input type="text" id="serie" value="F001" required>
                </div>
                <div class="form-group">
                    <label for="numero">N√∫mero (ej: 00001)</label>
                    <input type="number" id="numero" value="1" required>
                </div>
                <div class="form-group full-width">
                    <label for="fecha-emision">Fecha de Emisi√≥n</label>
                    <input type="date" id="fecha-emision" required>
                </div>
            </div>

            <h2>Datos del Cliente</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="cliente-ruc">RUC / DNI</label>
                    <input type="text" id="cliente-ruc" placeholder="Ej: 20123456789" required onblur="consultarRUC()">
                    <small style="color: #666; font-size: 0.9rem;">La raz√≥n social se completar√° autom√°ticamente</small>
                </div>
                <div class="form-group">
                    <label for="cliente-razon-social">Raz√≥n Social / Nombres</label>
                    <input type="text" id="cliente-razon-social" placeholder="Se completar√° autom√°ticamente" required>
                    <div id="ruc-loading" style="display: none; color: #17a2b8; font-size: 0.9rem; margin-top: 5px;">‚è≥ Consultando...</div>
                </div>
                <div class="form-group full-width">
                    <label for="cliente-direccion">Direcci√≥n</label>
                    <input type="text" id="cliente-direccion" placeholder="Se completar√° autom√°ticamente">
                </div>
            </div>

            <h2>Detalle de Productos / Servicios</h2>
            <div class="items-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Cantidad</th>
                            <th>Valor Unitario (S/)</th>
                            <th>Subtotal (S/)</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body">
                        <!-- Los √≠tems se agregar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
                <button type="button" class="btn btn-primary" onclick="addItem()">+ Agregar √çtem</button>
            </div>

            <div class="totals">
                <div><strong>Subtotal (S/):</strong> <span id="subtotal">0.00</span></div>
                <div><strong>IGV (18%):</strong> <span id="igv">0.00</span></div>
                <div class="total-amount"><strong>Total a Pagar (S/):</strong> <span id="total">0.00</span></div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-success" onclick="generatePDF()">üìÑ Generar PDF</button>
                <button type="button" class="btn btn-primary" onclick="generateXML()">üìã Generar XML</button>
                <button type="button" class="btn btn-info" onclick="emitToSUNAT()">üöÄ Emitir a SUNAT</button>
            </div>
            <div id="invoice-result" class="result-area" style="display: none; margin-top: 20px;"></div>
        </form>
        </div>

        <!-- Pesta√±a: Control CPE -->
        <div id="controlcpe" class="tab-content">
            <h2>Control de Comprobantes Electr√≥nicos (CPE)</h2>
            <p>Verifica el estado de tus facturas, boletas, notas, etc. en SUNAT.</p>
            <form id="controlcpe-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cpe-serie">Serie</label>
                        <input type="text" id="cpe-serie" placeholder="Ej: F001" required>
                    </div>
                    <div class="form-group">
                        <label for="cpe-numero">N√∫mero</label>
                        <input type="text" id="cpe-numero" placeholder="Ej: 000001" required>
                    </div>
                    <div class="form-group">
                        <label for="cpe-tipo">Tipo de Comprobante</label>
                        <select id="cpe-tipo" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 5px;">
                            <option value="01">Factura</option>
                            <option value="03">Boleta de Venta</option>
                            <option value="07">Nota de Cr√©dito</option>
                            <option value="08">Nota de D√©bito</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="checkCPE()">üîç Consultar Estado</button>
            </form>
            <div id="controlcpe-result" class="result-area" style="display: none;"></div>
        </div>

        <!-- Pesta√±a: MIGE IGV -->
        <div id="migeigv" class="tab-content">
            <h2>MIGE IGV - Libros Electr√≥nicos</h2>
            <p>Gestiona tus libros electr√≥nicos de compras y ventas (RCE y RVIE).</p>
            <form id="migeigv-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="mige-tipo">Tipo de Libro</label>
                        <select id="mige-tipo" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 5px;">
                            <option value="VENTAS">Registro de Ventas (RVIE)</option>
                            <option value="COMPRAS">Registro de Compras (RCE)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mige-periodo">Per√≠odo (YYYYMM)</label>
                        <input type="text" id="mige-periodo" placeholder="Ej: 202401" pattern="[0-9]{6}" required>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="mige-xml">XML del Libro (opcional)</label>
                    <textarea id="mige-xml" placeholder="Pega aqu√≠ el XML del libro electr√≥nico..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-primary" onclick="consultarLibro()">üìñ Consultar Libro</button>
                    <button type="button" class="btn btn-success" onclick="enviarLibro()">üì§ Enviar Libro</button>
                </div>
            </form>
            <div id="migeigv-result" class="result-area" style="display: none;"></div>
        </div>

        <!-- Pesta√±a: GRE Emisi√≥n -->
        <div id="gem" class="tab-content">
            <h2>GRE - Emisi√≥n de Comprobantes</h2>
            <p>Emite comprobantes electr√≥nicos (facturas, boletas, notas, gu√≠as) a SUNAT.</p>
            <form id="gem-form">
                <div class="form-group full-width">
                    <label for="gem-xml">XML del Comprobante</label>
                    <textarea id="gem-xml" placeholder="Pega aqu√≠ el XML del comprobante a emitir..." required></textarea>
                </div>
                <div class="form-group full-width">
                    <label>O genera el XML desde la factura actual:</label>
                    <button type="button" class="btn btn-info" onclick="generateXMLForGRE()">üìã Generar XML desde Factura</button>
                </div>
                <button type="button" class="btn btn-success" onclick="emitGRE()">üöÄ Emitir a SUNAT</button>
            </form>
            <div id="gem-result" class="result-area" style="display: none;"></div>
        </div>

        <!-- Pesta√±a: Control Mensajes -->
        <div id="controlmsg" class="tab-content">
            <h2>Control de Mensajes y Alertas</h2>
            <p>Consulta los mensajes, alertas y errores de SUNAT sobre tus comprobantes.</p>
            <form id="controlmsg-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="msg-fecha-desde">Fecha Desde</label>
                        <input type="date" id="msg-fecha-desde" required>
                    </div>
                    <div class="form-group">
                        <label for="msg-fecha-hasta">Fecha Hasta</label>
                        <input type="date" id="msg-fecha-hasta" required>
                    </div>
                    <div class="form-group">
                        <label for="msg-tipo">Tipo de Mensaje</label>
                        <select id="msg-tipo" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 5px;">
                            <option value="">Todos</option>
                            <option value="ERROR">Errores</option>
                            <option value="ALERTA">Alertas</option>
                            <option value="INFO">Informaci√≥n</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="consultarMensajes()">üì® Consultar Mensajes</button>
            </form>
            <div id="controlmsg-result" class="result-area" style="display: none;"></div>
        </div>

        <!-- Pesta√±a: SSPP Receptor -->
        <div id="sspp" class="tab-content">
            <h2>SSPP - Receptor XML</h2>
            <p>Env√≠a archivos XML a SUNAT para procesamiento o reenv√≠o.</p>
            <form id="sspp-form">
                <div class="form-group full-width">
                    <label for="sspp-xml">XML a Enviar</label>
                    <textarea id="sspp-xml" placeholder="Pega aqu√≠ el XML a enviar..." required></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="sspp-tipo">Tipo de Env√≠o</label>
                    <select id="sspp-tipo" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 5px;">
                        <option value="COMPROBANTE">Comprobante Electr√≥nico</option>
                        <option value="LIBRO">Libro Electr√≥nico</option>
                        <option value="RESUMEN">Resumen de Anulaciones</option>
                    </select>
                </div>
                <button type="button" class="btn btn-success" onclick="enviarSSPP()">üì§ Enviar XML</button>
            </form>
            <div id="sspp-result" class="result-area" style="display: none;"></div>
        </div>
    </div>

    <!-- Contenedor oculto para la vista previa que se convertir√° en PDF -->
    <div id="invoice-preview"></div>

    <!-- Scripts para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        const { jsPDF } = window.jspdf;
        const IGV_RATE = 0.18;

        // --- DATOS DE LA EMPRESA ---
        // Aqu√≠ est√°n tus datos actualizados
        const COMPANY_DATA = {
            ruc: '10735084726', 
            razonSocial: 'ACU√ëA LOLY DIKSON YAMPIER',
            direccion: 'Tu Direcci√≥n Aqu√≠', // Puedes agregar tu direcci√≥n si lo deseas
        };

        let itemCount = 0;

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer la fecha de hoy por defecto
            document.getElementById('fecha-emision').valueAsDate = new Date();
            // Agregar el primer √≠tem
            addItem();
        });

        // --- CONSULTA AUTOM√ÅTICA DE RUC/DNI ---
        async function consultarRUC() {
            const rucInput = document.getElementById('cliente-ruc');
            const razonSocialInput = document.getElementById('cliente-razon-social');
            const direccionInput = document.getElementById('cliente-direccion');
            const loadingDiv = document.getElementById('ruc-loading');
            
            const ruc = rucInput.value.trim();
            
            // Validar que tenga al menos 8 caracteres (DNI) o 11 (RUC)
            if (ruc.length < 8) {
                return;
            }

            // Si ya hay raz√≥n social y no est√° vac√≠a, no consultar (evitar sobrescribir)
            if (razonSocialInput.value.trim() !== '') {
                return;
            }

            // Mostrar indicador de carga
            loadingDiv.style.display = 'block';
            razonSocialInput.disabled = true;
            direccionInput.disabled = true;

            try {
                // Intentar m√∫ltiples APIs p√∫blicas de Per√∫
                let data = null;
                
                // M√©todo 1: API de apisperu.com (gratuita)
                try {
                    const response = await fetch(`https://api.apis.net.pe/v1/ruc?numero=${ruc}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.razonSocial) {
                            data = {
                                razonSocial: result.razonSocial,
                                direccion: result.direccion || result.direccionCompleta || ''
                            };
                        }
                    }
                } catch (e) {
                    console.log('API apisperu.com no disponible, intentando otra...');
                }

                // M√©todo 2: API alternativa (si la primera falla)
                if (!data) {
                    try {
                        const response = await fetch(`https://ruc.com.pe/api/beta/ruc?numero=${ruc}&token=demo`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.razonSocial || result.nombre) {
                                data = {
                                    razonSocial: result.razonSocial || result.nombre,
                                    direccion: result.direccion || result.direccionCompleta || ''
                                };
                            }
                        }
                    } catch (e) {
                        console.log('API alternativa no disponible');
                    }
                }

                // M√©todo 3: Si es DNI (8 d√≠gitos), intentar consulta b√°sica
                if (!data && ruc.length === 8) {
                    // Para DNI, generalmente no hay APIs p√∫blicas gratuitas confiables
                    // Pero podemos intentar con algunas APIs de terceros
                    try {
                        const response = await fetch(`https://api.reniec.cloud/dni/${ruc}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.nombres || result.nombre) {
                                const nombres = result.nombres || result.nombre || '';
                                const apellidos = result.apellidos || result.apellidoPaterno + ' ' + result.apellidoMaterno || '';
                                data = {
                                    razonSocial: `${nombres} ${apellidos}`.trim(),
                                    direccion: result.direccion || ''
                                };
                            }
                        }
                    } catch (e) {
                        console.log('API de DNI no disponible');
                    }
                }

                // Completar los campos si se obtuvo informaci√≥n
                if (data) {
                    razonSocialInput.value = data.razonSocial;
                    if (data.direccion) {
                        direccionInput.value = data.direccion;
                    }
                    loadingDiv.innerHTML = '‚úÖ Datos encontrados';
                    loadingDiv.style.color = '#28a745';
                    
                    // Ocultar el mensaje despu√©s de 2 segundos
                    setTimeout(() => {
                        loadingDiv.style.display = 'none';
                    }, 2000);
                } else {
                    loadingDiv.innerHTML = '‚ö†Ô∏è No se encontr√≥ informaci√≥n. Complete manualmente.';
                    loadingDiv.style.color = '#ffc107';
                    setTimeout(() => {
                        loadingDiv.style.display = 'none';
                    }, 3000);
                }

            } catch (error) {
                console.error('Error al consultar RUC/DNI:', error);
                loadingDiv.innerHTML = '‚ö†Ô∏è Error al consultar. Complete manualmente.';
                loadingDiv.style.color = '#dc3545';
                setTimeout(() => {
                    loadingDiv.style.display = 'none';
                }, 3000);
            } finally {
                razonSocialInput.disabled = false;
                direccionInput.disabled = false;
            }
        }

        // --- FUNCIONES PARA MANEJO DE √çTEMS ---
        function addItem() {
            itemCount++;
            const tableBody = document.getElementById('items-table-body');
            const row = document.createElement('tr');
            row.id = `item-row-${itemCount}`;
            row.innerHTML = `
                <td><input type="number" class="item-qty" value="1" min="1" onchange="calculateTotals()"></td>
                <td><input type="number" class="item-price" value="0.00" step="0.01" min="0" onchange="calculateTotals()"></td>
                <td class="item-subtotal">0.00</td>
                <td><button type="button" class="btn btn-danger" onclick="removeItem(${itemCount})">Eliminar</button></td>
            `;
            tableBody.appendChild(row);
            calculateTotals();
        }

        function removeItem(id) {
            const row = document.getElementById(`item-row-${id}`);
            if (document.querySelectorAll('#items-table-body tr').length > 1) {
                row.remove();
                calculateTotals();
            } else {
                alert('Debe haber al menos un √≠tem en la factura.');
            }
        }

        // --- C√ÅLCULOS ---
        function calculateTotals() {
            let subtotal = 0;
            const rows = document.querySelectorAll('#items-table-body tr');

            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const itemSubtotal = qty * price;
                row.querySelector('.item-subtotal').textContent = itemSubtotal.toFixed(2);
                subtotal += itemSubtotal;
            });

            const igv = subtotal * IGV_RATE;
            const total = subtotal + igv;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('igv').textContent = igv.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }

        // --- GENERACI√ìN DEL PDF ---
        function generatePDF() {
            calculateTotals(); // Asegurarse de que los totales est√©n actualizados

            const serie = document.getElementById('serie').value;
            const numero = document.getElementById('numero').value;
            const fechaEmision = document.getElementById('fecha-emision').value;
            const clienteRuc = document.getElementById('cliente-ruc').value;
            const clienteRazonSocial = document.getElementById('cliente-razon-social').value;
            const clienteDireccion = document.getElementById('cliente-direccion').value;

            if (!clienteRuc || !clienteRazonSocial) {
                alert('Por favor, complete los datos del cliente.');
                return;
            }
            
            // Validar que haya al menos un √≠tem con precio
            let hasValidItem = false;
            document.querySelectorAll('#items-table-body tr').forEach(row => {
                const price = parseFloat(row.querySelector('.item-price').value);
                if (price > 0) {
                    hasValidItem = true;
                }
            });

            if (!hasValidItem) {
                alert('Por favor, agregue al menos un √≠tem con un precio v√°lido.');
                return;
            }


            const preview = document.getElementById('invoice-preview');
            let itemsHtml = '';
            document.querySelectorAll('#items-table-body tr').forEach(row => {
                const qty = row.querySelector('.item-qty').value;
                const price = parseFloat(row.querySelector('.item-price').value).toFixed(2);
                const subtotal = parseFloat(row.querySelector('.item-subtotal').textContent).toFixed(2);
                if(parseFloat(price) > 0) {
                    itemsHtml += `
                        <tr>
                            <td style="text-align:center;">${qty}</td>
                            <td style="text-align:right;">${price}</td>
                            <td style="text-align:right;">${subtotal}</td>
                        </tr>
                    `;
                }
            });

            preview.innerHTML = `
                <div class="header">
                    <div class="company-info">
                        <h2>${COMPANY_DATA.razonSocial}</h2>
                        <p>RUC: ${COMPANY_DATA.ruc}</p>
                        <p>${COMPANY_DATA.direccion}</p>
                    </div>
                    <div class="invoice-details">
                        <h3>FACTURA ELECTR√ìNICA</h3>
                        <p><strong>Serie:</strong> ${serie}</p>
                        <p><strong>N√∫mero:</strong> ${String(numero).padStart(6, '0')}</p>
                        <p><strong>Fecha de Emisi√≥n:</strong> ${new Date(fechaEmision).toLocaleDateString('es-PE')}</p>
                    </div>
                </div>
                <div class="details-grid">
                    <div>
                        <h4>Cliente</h4>
                        <p><strong>Raz√≥n Social:</strong> ${clienteRazonSocial}</p>
                        <p><strong>RUC / DNI:</strong> ${clienteRuc}</p>
                        <p><strong>Direcci√≥n:</strong> ${clienteDireccion || 'N/A'}</p>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 20%;">Cantidad</th>
                            <th style="width: 40%;">Valor Unitario (S/)</th>
                            <th style="width: 40%;">Subtotal (S/)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                <div class="totals-section">
                    <p><strong>Subtotal (S/):</strong> ${document.getElementById('subtotal').textContent}</p>
                    <p><strong>IGV (18%):</strong> ${document.getElementById('igv').textContent}</p>
                    <p class="total"><strong>Total a Pagar (S/):</strong> ${document.getElementById('total').textContent}</p>
                </div>
            `;

            // Usar html2canvas y jsPDF para crear el PDF
            window.html2canvas(preview).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // Ancho A4 en mm
                const pageHeight = 295; // Altura A4 en mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`Factura-${serie}-${String(numero).padStart(6, '0')}.pdf`);
            });
        }

        // ============================================
        // FUNCIONES DE SUNAT
        // ============================================

        // Configuraci√≥n de SUNAT
        let SUNAT_CONFIG = {
            apiId: '',
            apiKey: '',
            usuario: '',
            password: '',
            ruc: '10735084726',
            apiUrl: 'https://api.sunat.gob.pe'
        };

        // Cargar configuraci√≥n guardada
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('sunatConfig');
            if (saved) {
                SUNAT_CONFIG = JSON.parse(saved);
                if (document.getElementById('sunat-api-id')) {
                    document.getElementById('sunat-api-id').value = SUNAT_CONFIG.apiId || '';
                    document.getElementById('sunat-api-key').value = SUNAT_CONFIG.apiKey || '';
                    document.getElementById('sunat-usuario').value = SUNAT_CONFIG.usuario || '';
                    document.getElementById('sunat-password').value = SUNAT_CONFIG.password || '';
                    document.getElementById('sunat-ruc').value = SUNAT_CONFIG.ruc || '10735084726';
                    document.getElementById('sunat-api-url').value = SUNAT_CONFIG.apiUrl || 'https://api.sunat.gob.pe';
                }
            }
            // Establecer fechas por defecto para mensajes
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            if (document.getElementById('msg-fecha-desde')) {
                document.getElementById('msg-fecha-desde').valueAsDate = firstDay;
                document.getElementById('msg-fecha-hasta').valueAsDate = today;
            }
        });

        // Sistema de Pesta√±as
        function showTab(tabName, buttonElement) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar la pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else if (window.event && window.event.target) {
                window.event.target.classList.add('active');
            }
        }

        // Guardar configuraci√≥n
        function saveConfig() {
            SUNAT_CONFIG = {
                apiId: document.getElementById('sunat-api-id').value,
                apiKey: document.getElementById('sunat-api-key').value,
                usuario: document.getElementById('sunat-usuario').value,
                password: document.getElementById('sunat-password').value,
                ruc: document.getElementById('sunat-ruc').value,
                apiUrl: document.getElementById('sunat-api-url').value
            };
            localStorage.setItem('sunatConfig', JSON.stringify(SUNAT_CONFIG));
            showResult('config-result', '‚úÖ Configuraci√≥n guardada correctamente', 'success');
        }

        // Cargar credenciales de ejemplo (tus credenciales reales)
        function loadExampleCredentials() {
            document.getElementById('sunat-api-id').value = 'a8485be7-fb67-41e6-9036-bc903e197cab';
            document.getElementById('sunat-api-key').value = 'ICn48qF1KeV5hW6opF55Mw==';
            showResult('config-result', '‚úÖ Credenciales de ejemplo cargadas. Ahora haz clic en "Guardar Configuraci√≥n"', 'success');
        }

        // Funci√≥n gen√©rica para llamadas a la API de SUNAT
        async function callSUNATAPI(endpoint, method = 'GET', body = null) {
            // Priorizar autenticaci√≥n con ID y Clave de API
            if (!SUNAT_CONFIG.apiId || !SUNAT_CONFIG.apiKey) {
                // Si no hay ID/Clave, intentar con usuario/password
                if (!SUNAT_CONFIG.usuario || !SUNAT_CONFIG.password) {
                    throw new Error('Por favor, configure sus credenciales de API SUNAT (ID y Clave) en la pesta√±a de Configuraci√≥n.');
                }
            }

            const url = `${SUNAT_CONFIG.apiUrl}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json'
            };

            // Autenticaci√≥n: Usar ID y Clave de API si est√°n disponibles, sino usuario/password
            if (SUNAT_CONFIG.apiId && SUNAT_CONFIG.apiKey) {
                // M√©todo 1: Headers personalizados (m√°s com√∫n en APIs modernas)
                headers['X-API-ID'] = SUNAT_CONFIG.apiId;
                headers['X-API-KEY'] = SUNAT_CONFIG.apiKey;
                // M√©todo 2: Tambi√©n intentar Basic Auth con ID:Clave (por si SUNAT lo requiere)
                // headers['Authorization'] = 'Basic ' + btoa(`${SUNAT_CONFIG.apiId}:${SUNAT_CONFIG.apiKey}`);
            } else if (SUNAT_CONFIG.usuario && SUNAT_CONFIG.password) {
                headers['Authorization'] = 'Basic ' + btoa(`${SUNAT_CONFIG.usuario}:${SUNAT_CONFIG.password}`);
            }

            const options = {
                method: method,
                headers: headers
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, options);
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = await response.text();
                }
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // 1. Control CPE - Verificar estado de comprobante
        async function checkCPE() {
            const serie = document.getElementById('cpe-serie').value;
            const numero = document.getElementById('cpe-numero').value;
            const tipo = document.getElementById('cpe-tipo').value;

            showLoading('controlcpe-result', true);
            
            try {
                const result = await callSUNATAPI(
                    `/v1/contribuyente/controlcpe?ruc=${SUNAT_CONFIG.ruc}&tipo=${tipo}&serie=${serie}&numero=${numero}`,
                    'GET'
                );
                
                showLoading('controlcpe-result', false);
                if (result.success) {
                    showResult('controlcpe-result', 
                        `Estado del CPE:\n${JSON.stringify(result.data, null, 2)}`, 
                        'success');
                } else {
                    showResult('controlcpe-result', 
                        `Error: ${result.error || JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showLoading('controlcpe-result', false);
                showResult('controlcpe-result', `Error: ${error.message}`, 'error');
            }
        }

        // 2. MIGE IGV - Consultar Libro
        async function consultarLibro() {
            const tipo = document.getElementById('mige-tipo').value;
            const periodo = document.getElementById('mige-periodo').value;

            showLoading('migeigv-result', true);
            
            try {
                const result = await callSUNATAPI(
                    `/v1/contribuyente/migeigv?ruc=${SUNAT_CONFIG.ruc}&tipo=${tipo}&periodo=${periodo}`,
                    'GET'
                );
                
                showLoading('migeigv-result', false);
                if (result.success) {
                    showResult('migeigv-result', 
                        `Libro ${tipo} - Per√≠odo ${periodo}:\n${JSON.stringify(result.data, null, 2)}`, 
                        'success');
                } else {
                    showResult('migeigv-result', 
                        `Error: ${result.error || JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showLoading('migeigv-result', false);
                showResult('migeigv-result', `Error: ${error.message}`, 'error');
            }
        }

        // 2. MIGE IGV - Enviar Libro
        async function enviarLibro() {
            const tipo = document.getElementById('mige-tipo').value;
            const periodo = document.getElementById('mige-periodo').value;
            const xml = document.getElementById('mige-xml').value;

            if (!xml) {
                alert('Por favor, ingrese el XML del libro.');
                return;
            }

            showLoading('migeigv-result', true);
            
            try {
                const result = await callSUNATAPI(
                    `/v1/contribuyente/migeigv`,
                    'POST',
                    {
                        ruc: SUNAT_CONFIG.ruc,
                        tipo: tipo,
                        periodo: periodo,
                        xml: xml
                    }
                );
                
                showLoading('migeigv-result', false);
                if (result.success) {
                    showResult('migeigv-result', 
                        `Libro enviado correctamente:\n${JSON.stringify(result.data, null, 2)}`, 
                        'success');
                } else {
                    showResult('migeigv-result', 
                        `Error: ${result.error || JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showLoading('migeigv-result', false);
                showResult('migeigv-result', `Error: ${error.message}`, 'error');
            }
        }

        // 3. GRE - Emitir Comprobante
        async function emitGRE() {
            const xml = document.getElementById('gem-xml').value;

            if (!xml) {
                alert('Por favor, ingrese el XML del comprobante.');
                return;
            }

            showLoading('gem-result', true);
            
            try {
                const result = await callSUNATAPI(
                    `/v1/contribuyente/gem`,
                    'POST',
                    {
                        ruc: SUNAT_CONFIG.ruc,
                        xml: xml
                    }
                );
                
                showLoading('gem-result', false);
                if (result.success) {
                    showResult('gem-result', 
                        `Comprobante emitido correctamente:\n${JSON.stringify(result.data, null, 2)}`, 
                        'success');
                } else {
                    showResult('gem-result', 
                        `Error: ${result.error || JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showLoading('gem-result', false);
                showResult('gem-result', `Error: ${error.message}`, 'error');
            }
        }

        // 4. Control Mensajes
        async function consultarMensajes() {
            const fechaDesde = document.getElementById('msg-fecha-desde').value;
            const fechaHasta = document.getElementById('msg-fecha-hasta').value;
            const tipo = document.getElementById('msg-tipo').value;

            showLoading('controlmsg-result', true);
            
            try {
                let url = `/v1/contribuyente/controlmsg?ruc=${SUNAT_CONFIG.ruc}&fechaDesde=${fechaDesde}&fechaHasta=${fechaHasta}`;
                if (tipo) {
                    url += `&tipo=${tipo}`;
                }
                
                const result = await callSUNATAPI(url, 'GET');
                
                showLoading('controlmsg-result', false);
                if (result.success) {
                    showResult('controlmsg-result', 
                        `Mensajes encontrados:\n${JSON.stringify(result.data, null, 2)}`, 
                        'success');
                } else {
                    showResult('controlmsg-result', 
                        `Error: ${result.error || JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showLoading('controlmsg-result', false);
                showResult('controlmsg-result', `Error: ${error.message}`, 'error');
            }
        }

        // 5. SSPP - Enviar XML
        async function enviarSSPP() {
            const xml = document.getElementById('sspp-xml').value;
            const tipo = document.getElementById('sspp-tipo').value;

            if (!xml) {
                alert('Por favor, ingrese el XML a enviar.');
                return;
            }

            showLoading('sspp-result', true);
            
            try {
                const result = await callSUNATAPI(
                    `/v1/contribuyente/enviossp`,
                    'POST',
                    {
                        ruc: SUNAT_CONFIG.ruc,
                        tipo: tipo,
                        xml: xml
                    }
                );
                
                showLoading('sspp-result', false);
                if (result.success) {
                    showResult('sspp-result', 
                        `XML enviado correctamente:\n${JSON.stringify(result.data, null, 2)}`, 
                        'success');
                } else {
                    showResult('sspp-result', 
                        `Error: ${result.error || JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showLoading('sspp-result', false);
                showResult('sspp-result', `Error: ${error.message}`, 'error');
            }
        }

        // Generar XML UBL 2.1 para la factura actual
        function generateXML() {
            const invoiceData = getInvoiceData();
            if (!invoiceData) return;

            const xml = generateUBLXML(invoiceData);
            const resultDiv = document.getElementById('invoice-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<pre>${escapeHtml(xml)}</pre><button class="btn btn-primary" onclick="copyToClipboard('${escapeForJS(xml)}')">üìã Copiar XML</button>`;
        }

        function generateXMLForGRE() {
            generateXML();
            // Copiar al textarea de GRE
            setTimeout(() => {
                const xml = generateUBLXML(getInvoiceData());
                document.getElementById('gem-xml').value = xml;
                const gemButton = document.querySelector('.tab-button[onclick*="gem"]');
                showTab('gem', gemButton);
            }, 100);
        }

        // Emitir factura a SUNAT
        async function emitToSUNAT() {
            const invoiceData = getInvoiceData();
            if (!invoiceData) return;

            const xml = generateUBLXML(invoiceData);
            document.getElementById('gem-xml').value = xml;
            const gemButton = document.querySelector('.tab-button[onclick*="gem"]');
            showTab('gem', gemButton);
            // Auto-emitir despu√©s de un momento
            setTimeout(() => {
                emitGRE();
            }, 500);
        }

        // Obtener datos de la factura actual
        function getInvoiceData() {
            const serie = document.getElementById('serie').value;
            const numero = document.getElementById('numero').value;
            const fechaEmision = document.getElementById('fecha-emision').value;
            const clienteRuc = document.getElementById('cliente-ruc').value;
            const clienteRazonSocial = document.getElementById('cliente-razon-social').value;
            const clienteDireccion = document.getElementById('cliente-direccion').value;

            if (!clienteRuc || !clienteRazonSocial) {
                alert('Por favor, complete los datos del cliente.');
                return null;
            }

            const items = [];
            document.querySelectorAll('#items-table-body tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                if (qty > 0 && price > 0) {
                    items.push({
                        cantidad: qty,
                        precioUnitario: price,
                        subtotal: qty * price
                    });
                }
            });

            if (items.length === 0) {
                alert('Por favor, agregue al menos un √≠tem con precio v√°lido.');
                return null;
            }

            calculateTotals();
            const subtotal = parseFloat(document.getElementById('subtotal').textContent);
            const igv = parseFloat(document.getElementById('igv').textContent);
            const total = parseFloat(document.getElementById('total').textContent);

            return {
                serie, numero, fechaEmision,
                cliente: { ruc: clienteRuc, razonSocial: clienteRazonSocial, direccion: clienteDireccion },
                items, subtotal, igv, total
            };
        }

        // Generar XML UBL 2.1 (formato simplificado)
        function generateUBLXML(data) {
            const fecha = new Date(data.fechaEmision).toISOString().split('T')[0];
            const numeroCompleto = `${data.serie}-${String(data.numero).padStart(6, '0')}`;
            
            return `<?xml version="1.0" encoding="UTF-8"?>
<Invoice xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
         xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
         xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
    <cbc:UBLVersionID>2.1</cbc:UBLVersionID>
    <cbc:CustomizationID>2.0</cbc:CustomizationID>
    <cbc:ID>${numeroCompleto}</cbc:ID>
    <cbc:IssueDate>${fecha}</cbc:IssueDate>
    <cbc:InvoiceTypeCode>01</cbc:InvoiceTypeCode>
    <cac:AccountingSupplierParty>
        <cac:Party>
            <cac:PartyIdentification>
                <cbc:ID schemeID="6">${COMPANY_DATA.ruc}</cbc:ID>
            </cac:PartyIdentification>
            <cac:PartyLegalEntity>
                <cbc:RegistrationName>${COMPANY_DATA.razonSocial}</cbc:RegistrationName>
            </cac:PartyLegalEntity>
        </cac:Party>
    </cac:AccountingSupplierParty>
    <cac:AccountingCustomerParty>
        <cac:Party>
            <cac:PartyIdentification>
                <cbc:ID schemeID="${data.cliente.ruc.length === 11 ? '6' : '1'}">${data.cliente.ruc}</cbc:ID>
            </cac:PartyIdentification>
            <cac:PartyLegalEntity>
                <cbc:RegistrationName>${data.cliente.razonSocial}</cbc:RegistrationName>
            </cac:PartyLegalEntity>
        </cac:Party>
    </cac:AccountingCustomerParty>
    ${data.items.map((item, index) => `
    <cac:InvoiceLine>
        <cbc:ID>${index + 1}</cbc:ID>
        <cbc:InvoicedQuantity unitCode="NIU">${item.cantidad}</cbc:InvoicedQuantity>
        <cbc:LineExtensionAmount currencyID="PEN">${item.subtotal.toFixed(2)}</cbc:LineExtensionAmount>
        <cac:PricingReference>
            <cac:AlternativeConditionPrice>
                <cbc:PriceAmount currencyID="PEN">${item.precioUnitario.toFixed(2)}</cbc:PriceAmount>
            </cac:AlternativeConditionPrice>
        </cac:PricingReference>
        <cac:Item>
            <cbc:Description>Producto/Servicio ${index + 1}</cbc:Description>
        </cac:Item>
        <cac:Price>
            <cbc:PriceAmount currencyID="PEN">${item.precioUnitario.toFixed(2)}</cbc:PriceAmount>
        </cac:Price>
    </cac:InvoiceLine>`).join('')}
    <cac:TaxTotal>
        <cbc:TaxAmount currencyID="PEN">${data.igv.toFixed(2)}</cbc:TaxAmount>
        <cac:TaxSubtotal>
            <cbc:TaxableAmount currencyID="PEN">${data.subtotal.toFixed(2)}</cbc:TaxableAmount>
            <cbc:TaxAmount currencyID="PEN">${data.igv.toFixed(2)}</cbc:TaxAmount>
            <cac:TaxCategory>
                <cac:TaxScheme>
                    <cbc:ID>1000</cbc:ID>
                    <cbc:Name>IGV</cbc:Name>
                    <cbc:TaxTypeCode>VAT</cbc:TaxTypeCode>
                </cac:TaxScheme>
            </cac:TaxCategory>
        </cac:TaxSubtotal>
    </cac:TaxTotal>
    <cac:LegalMonetaryTotal>
        <cbc:LineExtensionAmount currencyID="PEN">${data.subtotal.toFixed(2)}</cbc:LineExtensionAmount>
        <cbc:TaxInclusiveAmount currencyID="PEN">${data.total.toFixed(2)}</cbc:TaxInclusiveAmount>
        <cbc:PayableAmount currencyID="PEN">${data.total.toFixed(2)}</cbc:PayableAmount>
    </cac:LegalMonetaryTotal>
</Invoice>`;
        }

        // Funciones auxiliares
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            const badgeClass = type === 'success' ? 'status-success' : type === 'error' ? 'status-error' : 'status-pending';
            element.innerHTML = `<div class="${badgeClass}">${type.toUpperCase()}</div><pre>${escapeHtml(message)}</pre>`;
        }

        function showLoading(elementId, show) {
            const element = document.getElementById(elementId);
            if (show) {
                element.style.display = 'block';
                element.innerHTML = '<div class="loading active">‚è≥ Procesando...</div>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeForJS(text) {
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('XML copiado al portapapeles');
            });
        }
    </script>
</body>
</html>

